<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çº¢åŒ…"é¢ˆ"ä¸Šæ·»èŠ±ï¼Œæ–°æ˜¥æ”¾æ¾å°æ¸¸æˆ</title>
    <!-- TensorFlow.js Dependencies - æœ¬åœ°ç‰ˆæœ¬ -->
    <script src="libs/tf-core.min.js"></script>
    <script src="libs/tf-converter.min.js"></script>
    <script src="libs/tf-backend-webgl.min.js"></script>
    <script src="libs/pose-detection.min.js"></script>

    <!-- IndexedDB Storage Logic -->
    <script src="js/storage-idb.js"></script>

    <style>
        :root {
            --primary-red: #E60012;
            --primary-gold: #FFD700;
            --bg-gradient: linear-gradient(135deg, #E60012 0%, #FF6B00 25%, #FFD700 50%, #FF6B00 75%, #E60012 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(230, 0, 18, 0.8);
            --text-glow: 0 0 20px rgba(255, 215, 0, 1);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #000000;
            color: white;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
        }

        #debugger {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 999;
            width: 220px;
            border: 1px solid #333;
            pointer-events: none;
            display: none;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 320px;
            height: 100vh;
            padding: 20px;
            gap: 20px;
            box-sizing: border-box;
        }

        /* æ‘„åƒå¤´åŒºåŸŸ */
        .camera-wrapper {
            position: relative;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid var(--primary-gold);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.6), 0 0 80px rgba(230, 0, 18, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video,
        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* å³ä¾§é¢æ¿ */
        .ui-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stat-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-card {
            background: rgba(230, 0, 18, 0.4);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(255, 215, 0, 0.1);
        }

        .stat-val {
            font-size: 36px;
            font-weight: 900;
            color: #FFFFFF;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8),
                         0 0 20px rgba(255, 215, 0, 0.6),
                         0 3px 8px rgba(0, 0, 0, 0.8);
            font-variant-numeric: tabular-nums;
            letter-spacing: 1px;
        }

        .stat-lbl {
            font-size: 13px;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 5px;
            font-weight: 700;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.8),
                         0 0 8px rgba(230, 0, 18, 0.5);
        }

        /* è¿›åº¦æ¡ */
        .progress-box {
            margin-top: 5px;
        }

        .progress-track {
            height: 28px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.6),
                        0 0 15px rgba(255, 215, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.4);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #E60012, #FFD700, #E60012);
            width: 0%;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg,
                    rgba(255, 255, 255, 0.2) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.2) 75%,
                    transparent 75%,
                    transparent);
            background-size: 20px 20px;
            animation: moveStripe 1s linear infinite;
        }

        @keyframes moveStripe {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 20px 0;
            }
        }

        /* é€Ÿåº¦çº¿ç‰¹æ•ˆ */
        #speed-lines {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 50%, rgba(255, 255, 255, 0.5) 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 500;
            transition: opacity 0.5s;
            mix-blend-mode: overlay;
        }

        #speed-lines.active {
            opacity: 1;
            animation: pulse-zoom 0.2s infinite;
        }

        @keyframes pulse-zoom {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        /* å¿«ç…§é—ªå…‰ */
        #flash {
            position: absolute;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            transition: opacity 0.1s;
        }

        /* æŒ‘æˆ˜å¼¹çª— */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(135deg, rgba(230, 0, 18, 0.98) 0%, rgba(200, 0, 0, 0.98) 100%);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            border: 5px solid var(--primary-gold);
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.8), 0 0 120px rgba(230, 0, 18, 0.5);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 80%;
            max-width: 360px;
        }

        .modal.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        /* æ–°ç‰ˆä»»åŠ¡å¡æ ·å¼ */
        .challenge-modal-new {
            padding: 16px 16px 12px;
            max-width: 420px;
            width: 88%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .challenge-img-wrap {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 0;
        }

        .challenge-img-wrap img {
            width: 90%;
            max-height: 45vh;
            object-fit: contain;
            border-radius: 16px;
            border: 3px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .challenge-desc-text {
            font-size: 2rem;
            font-weight: 900;
            color: #FFFFFF;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5), 0 0 20px rgba(255,215,0,0.4);
            margin: 12px 0 4px;
            letter-spacing: 2px;
        }

        .challenge-bottom-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 4px;
        }

        .challenge-timeout-text {
            font-size: 1.1rem;
            color: #FFD700;
            margin: 0;
            font-weight: bold;
        }

        .challenge-skip-btn {
            background: #FF5252;
            color: white;
            border: none;
            padding: 10px 28px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
        }

        .challenge-bottom-row .timer-container {
            width: 100px;
            height: 100px;
            margin: 0;
        }

        .challenge-bottom-row .timer-text {
            font-size: 32px;
        }

        .timer-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 20px auto;
        }

        .timer-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 10;
        }

        .timer-progress {
            fill: none;
            stroke: #00E676;
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 440;
            /* 2 * PI * 70 */
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.1s linear;
        }

        /* Success State */
        .timer-progress.success {
            stroke: #FFD700;
            filter: drop-shadow(0 0 10px #FFD700);
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* é®ç½©å±‚ */
        #overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a0a0a 0%, #2d1414 50%, #1a0a0a 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        /* æ·»åŠ çº¢åŒ…åŠ¨ç”»æ•ˆæœ */
        #overlay::before {
            content: 'ğŸ§§';
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 60px;
            animation: float 3s ease-in-out infinite;
            opacity: 0.8;
        }

        #overlay::after {
            content: 'ğŸ§§';
            position: absolute;
            top: 15%;
            right: 10%;
            font-size: 60px;
            animation: float 3s ease-in-out infinite 1.5s;
            opacity: 0.8;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        h1.title {
            font-size: 3.5rem;
            background: linear-gradient(to bottom, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-color: transparent;
            margin: 0 0 20px 0;
            padding: 0;
            text-shadow: none;
            text-align: center;
            letter-spacing: 2px;
            filter: none;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            display: inline-block;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
        }

        /* æ¸¸æˆæŒ‡å¼•æ»šåŠ¨æç¤º */
        .game-tips-box {
            width: 100%;
            max-width: 340px;
            margin-bottom: 30px;
            text-align: center;
        }
        .game-tips-label {
            font-size: 0.75rem;
            color: rgba(255, 215, 0, 0.6);
            letter-spacing: 3px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .game-tips-wrapper {
            height: 28px;
            overflow: hidden;
            position: relative;
        }
        .game-tips-item {
            position: absolute;
            width: 100%;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.75);
            font-weight: 400;
            line-height: 28px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }
        .game-tips-item.active {
            opacity: 1;
            transform: translateY(0);
        }
        .game-tips-item.exit {
            opacity: 0;
            transform: translateY(-20px);
        }

        .menu-grid {
            display: grid;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }

        .btn {
            border: none;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            box-sizing: border-box;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #E60012 100%);
            color: white;
            box-shadow: 0 8px 30px rgba(230, 0, 18, 0.6), 0 0 20px rgba(255, 215, 0, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            filter: brightness(1.2);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .guide-text {
            color: #FFD700;
            margin-top: 30px;
            font-size: 15px;
            line-height: 1.8;
            text-align: center;
            max-width: 500px;
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        }

        /* æ¸¸æˆæ§åˆ¶æŒ‰é’® */
        .game-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 500;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 215, 0, 0.6);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            transform: scale(1.05);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
                padding: 10px;
                gap: 10px;
                height: 100dvh;
                /* use dynamic viewport height */
            }

            .camera-wrapper {
                border-radius: 15px;
                width: 100%;
                height: 100%;
            }

            /* è®©UIé¢æ¿æ›´ç´§å‡‘ */
            .ui-panel {
                flex-direction: column;
                padding: 15px;
                gap: 10px;
                background: rgba(0, 0, 0, 0.6);
                /* æ›´æ·±çš„èƒŒæ™¯ä»¥ä¾¿é˜…è¯» */
                backdrop-filter: blur(10px);
            }

            .stat-group {
                grid-template-columns: repeat(4, 1fr);
                /* ä¸€è¡Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ® */
                gap: 8px;
            }

            .stat-card {
                padding: 8px 5px;
                background: rgba(255, 255, 255, 0.05);
            }

            .stat-val {
                font-size: 18px;
                /* ç¼©å°å­—ä½“ */
            }

            .stat-lbl {
                font-size: 10px;
                transform: scale(0.9);
            }

            /* è¿›åº¦æ¡ */
            .progress-box {
                margin-top: 5px;
            }

            /* è°ƒæ•´å¼¹çª—å¤§å° */
            .modal {
                width: 90%;
            }

            .challenge-modal-new {
                padding: 12px 12px 10px;
            }

            .challenge-desc-text {
                font-size: 1.6rem;
            }

            .challenge-bottom-row .timer-container {
                width: 80px;
                height: 80px;
            }

            .challenge-bottom-row .timer-text {
                font-size: 28px;
            }

            .challenge-img-wrap img {
                max-height: 38vh;
            }

            .timer-ring {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }

            h1.title {
                font-size: 2rem;
            }

            /* è°ƒæ•´é®ç½©èœå• */
            #menu-content {
                width: 90%;
            }

            .timer-container {
                width: 120px;
                height: 120px;
            }

            .timer-text {
                font-size: 40px;
            }
    </style>
</head>

<body>

    <div id="debugger">Loading Model...</div>
    <div id="flash"></div>
    <div id="speed-lines"></div>

    <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
    <div class="game-controls" id="game-controls" style="display:none;">
        <button class="control-btn" id="pause-btn" onclick="togglePause()">â¸ï¸ æš‚åœ</button>
        <button class="control-btn" id="end-btn" onclick="endGame()">ğŸ›‘ ç»“æŸ</button>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm" loop autoplay>
        <source src="game-music.mp3" type="audio/mpeg">
    </audio>

    <div class="container">
        <div class="camera-wrapper">
            <video id="video" playsinline></video>
            <canvas id="output"></canvas>

            <div id="challenge-modal" class="modal challenge-modal-new">
                <div id="c-icon" class="challenge-img-wrap"></div>
                <p id="c-desc" class="challenge-desc-text"></p>
                <div class="challenge-bottom-row">
                    <div class="timer-container" id="c-timer-container">
                        <svg class="timer-svg" viewBox="0 0 160 160">
                            <circle class="timer-bg" cx="80" cy="80" r="70"></circle>
                            <circle class="timer-progress" id="c-timer-bar" cx="80" cy="80" r="70"></circle>
                        </svg>
                        <div class="timer-text" id="c-timer">5.0</div>
                    </div>
                    <p id="c-timeout" class="challenge-timeout-text">è¶…æ—¶å€’è®¡æ—¶: 30ç§’</p>
                </div>
                <button id="c-skip-btn" onclick="skipChallenge()" class="challenge-skip-btn">
                    â­ï¸ è·³è¿‡ä»»åŠ¡
                </button>
                <h2 id="c-title" style="display:none;"></h2>
            </div>

            <!-- Countdown Overlay -->
            <div id="countdown-overlay"
                style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:120px; font-weight:900; color:#FFF; text-shadow:0 0 30px #FF0000; display:none; z-index:200; pointer-events:none;">
                3</div>
        </div>

        <div class="ui-panel">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div class="stat-group">
                    <div class="stat-card">
                        <div class="stat-val" id="disp-time" style="color:#FFF;">120</div>
                        <div class="stat-lbl">â³ å‰©ä½™æ—¶é—´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="disp-cal">0</div>
                        <div class="stat-lbl">ğŸ§§ å‘è´¢çº¢åŒ…</div>
                    </div>
                </div>
            </div>

            <div class="progress-box">
                <div
                    style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px; color:#ffb300;">
                    <span>TIME</span>
                    <span id="target-dist-text">120s</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="prog-fill" style="width:100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»èœå• / ç»“æŸ é®ç½© -->
    <div id="overlay">
        <h1 class="title">çº¢åŒ…"é¢ˆ"ä¸Šæ·»èŠ±</h1>
        <p style="font-size:1.3rem; color:#FFFFFF; margin-top:-10px; margin-bottom:30px; font-weight:500; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);">æ–°æ˜¥æ”¾æ¾å°æ¸¸æˆ</p>

        <div id="menu-content"
            style="text-align:center; width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="menu-grid" id="menu-buttons">
                <button class="btn btn-primary" id="btn-start" onclick="init()">ğŸš€ å¼€å§‹æŒ‘æˆ˜</button>
            </div>

            <div id="menu-best" style="margin-top:25px; width:100%; max-width:300px; display:none;">
                <p style="color:#FFD700; font-size:14px; margin-bottom:8px; font-weight:600;">ğŸ† ä¸ªäººæœ€ä½³ Top 3</p>
                <div id="menu-best-list" style="color:#fff; font-size:14px; line-height:2;"></div>
            </div>

            <p id="loading-text" style="margin-top:30px; color:#aaa; font-size:14px; display:none;">
                <span class="spinner">â³</span> æ­£åœ¨é¢„çƒ­AIè§†è§‰å¼•æ“...
            </p>
        </div>

        <div id="result-content"
            style="display:none; text-align:center; width:100%; flex-direction:column; align-items:center;">
            <div style="font-size:80px; margin-bottom:20px;">ğŸ‰</div>
            <div id="new-record-badge" style="display:none; color:#FF5252; font-size:1.2rem; font-weight:bold; margin-bottom:10px; text-shadow: 0 0 15px rgba(255,82,82,0.8);">ğŸ–ï¸ æ–°çºªå½•!</div>
            <h2 style="color:#FFD700; font-size:2.5rem; margin:0; text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);">æŒ‘æˆ˜æˆåŠŸ!</h2>
            <p style="font-size:1.5rem; color:#FFD700; margin:20px 0; font-weight:700; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);">
                æœ€ç»ˆå¾—åˆ†: <span id="res-time" style="color:#FFFFFF; font-weight:bold; text-shadow: 0 0 15px rgba(255, 215, 0, 1);">0</span> åˆ†
            </p>

            <div class="menu-grid">
                <button class="btn btn-primary" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
                <button class="btn btn-secondary" id="btn-view-photos" onclick="viewPhotos()">ğŸ“¸ æŸ¥çœ‹ç…§ç‰‡</button>
            </div>
        </div>

        <div class="game-tips-box" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%);">
            <div class="game-tips-label">â€” æ¸¸æˆæŒ‡å¼• â€”</div>
            <div class="game-tips-wrapper" id="game-tips-wrapper">
                <div class="game-tips-item active">è½¬åŠ¨å¤´éƒ¨å’Œè‚©è†€ï¼Œå·¦å³ç§»åŠ¨å»æ¥ä½æ‰è½çš„çº¢åŒ…</div>
                <div class="game-tips-item">æ¸¸æˆä¸­ä¼šéšæœºå¼¹å‡ºå°ä»»åŠ¡ï¼ŒæŒ‰æç¤ºåšåŠ¨ä½œå³å¯å®Œæˆ</div>
                <div class="game-tips-item">ä¸¾æ‰‹ã€æŠ¬å¤´ã€åŒæ‰‹æ”¾é¢ˆå...è·Ÿç€åšæ”¾æ¾è‚©é¢ˆ</div>
                <div class="game-tips-item">æ¯ä¸ªå°ä»»åŠ¡éœ€ä¿æŒå§¿åŠ¿ 3 ç§’ï¼Œæ³¨æ„å€’è®¡æ—¶</div>
                <div class="game-tips-item">æ¥åˆ°çš„çº¢åŒ…è¶Šå¤šï¼Œåˆ†æ•°è¶Šé«˜ï¼ŒæŒ‘æˆ˜ä½ çš„æœ€ä½³çºªå½•å§</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { ItemSystem } from './js/game/ItemSystem.js';
        import { ParticleSystem } from './js/game/ParticleSystem.js';
        import { SoundSystem } from './js/game/SoundSystem.js';

        window.ItemSystem = ItemSystem;
        window.ParticleSystem = ParticleSystem;
        window.SoundSystem = SoundSystem;
    </script>

    <script>
        // --- 0. æ¸¸æˆæŒ‡å¼•æ»šåŠ¨ ---
        (function() {
            let tipIndex = 0;
            let tipTimer = null;
            function rotateTips() {
                const wrapper = document.getElementById('game-tips-wrapper');
                if (!wrapper) return;
                const items = wrapper.querySelectorAll('.game-tips-item');
                if (items.length === 0) return;
                const current = items[tipIndex];
                current.classList.remove('active');
                current.classList.add('exit');
                tipIndex = (tipIndex + 1) % items.length;
                const next = items[tipIndex];
                next.classList.remove('exit');
                next.classList.add('active');
                setTimeout(() => { current.classList.remove('exit'); }, 600);
            }
            tipTimer = setInterval(rotateTips, 3500);
        })();

        // --- 1. æ¸¸æˆé…ç½® ---
        const CONFIG = {
            gameDuration: 60, // æ¸¸æˆæ—¶é•¿ 60ç§’ (1åˆ†é’Ÿ)
            thresholds: [10, 25, 40, 55], // è§¦å‘æŒ‘æˆ˜çš„æ—¶é—´ç‚¹ï¼ˆç§’ï¼‰- å…±4æ¬¡ä»»åŠ¡ï¼Œé—´éš”çº¦15ç§’
            holdTime: 3000, // ä¿æŒå§¿åŠ¿ 3000ms (3ç§’)
            packetSpawnRate: 1500, // ç”Ÿæˆé—´éš”
            packetSpeed: 0.009 // åŸºç¡€é€Ÿåº¦ï¼ˆä»0.006åŠ å¿«åˆ°0.009ï¼Œæå‡50%ï¼‰
        };

        // å§¿åŠ¿å®šä¹‰ - æ˜¥èŠ‚å–œåº†åŠ¨ä½œ
        const CHALLENGES = [
            {
                id: 'raise_left_hand',
                name: 'ğŸŠ å·¦æ‰‹æ‹›è´¢',
                icon: 'ä»»åŠ¡æŒ‡å¼•å›¾ç‰‡/ä¸¾å·¦æ‰‹.jpg',
                desc: 'ä¸¾èµ·å·¦æ‰‹ï¼Œæ”¾æ¾å·¦è‚©',
                check: (kp) => {
                    // å·¦æ‰‹å¿…é¡»æ˜æ˜¾é«˜äºå·¦è‚©
                    const leftUp = kp.lw.y < kp.ls.y - 0.05;
                    return leftUp;
                }
            },
            {
                id: 'raise_right_hand',
                name: 'ğŸŠ å³æ‰‹æ‹›è´¢',
                icon: 'ä»»åŠ¡æŒ‡å¼•å›¾ç‰‡/ä¸¾å³æ‰‹.jpg',
                desc: 'ä¸¾èµ·å³æ‰‹ï¼Œæ”¾æ¾å³è‚©',
                check: (kp) => {
                    // å³æ‰‹å¿…é¡»æ˜æ˜¾é«˜äºå³è‚©
                    const rightUp = kp.rw.y < kp.rs.y - 0.05;
                    return rightUp;
                }
            },
            {
                id: 'hands_up',
                name: 'ğŸ† æ­¥æ­¥é«˜å‡',
                icon: 'ä»»åŠ¡æŒ‡å¼•å›¾ç‰‡/é«˜ä¸¾åŒæ‰‹.JPG',
                desc: 'åŒæ‰‹é«˜ä¸¾è¿‡å¤´ï¼Œæ‹‰ä¼¸è‚©é¢ˆ',
                check: (kp) => {
                    // åŒæ‰‹éƒ½å¿…é¡»æ˜æ˜¾é«˜äºè‚©è†€
                    return kp.lw.y < kp.ls.y - 0.08 && kp.rw.y < kp.rs.y - 0.08;
                }
            },
            {
                id: 'hands_on_neck',
                name: 'ğŸ ç¦æ°”ä¸´é—¨',
                icon: 'ä»»åŠ¡æŒ‡å¼•å›¾ç‰‡/åŒæ‰‹æŠ±å¤´.JPG',
                desc: 'åŒæ‰‹æ”¾åœ¨è„–å­åé¢ï¼Œæ”¾æ¾é¢ˆéƒ¨',
                check: (kp) => {
                    // åŒæ‰‹éƒ½åœ¨å¤´éƒ¨/é¢ˆéƒ¨é«˜åº¦ï¼ˆé«˜äºè‚©è†€ï¼‰
                    const handsUp = kp.lw.y < kp.ls.y && kp.rw.y < kp.rs.y;
                    // åŒæ‰‹é è¿‘å¤´éƒ¨ä¸­å¿ƒ
                    const noseX = kp.nose.x;
                    const leftNearHead = Math.abs(kp.lw.x - noseX) < 0.25;
                    const rightNearHead = Math.abs(kp.rw.x - noseX) < 0.25;
                    return handsUp && leftNearHead && rightNearHead;
                }
            },
            {
                id: 'look_up',
                name: 'ğŸŒŸ æŠ¬å¤´çœ‹çƒŸèŠ±',
                icon: 'ä»»åŠ¡æŒ‡å¼•å›¾ç‰‡/æŠ¬å¤´.JPG',
                desc: 'æŠ¬å¤´æœå¤©çœ‹ï¼Œæ”¾æ¾é¢ˆéƒ¨',
                check: (kp) => {
                    // æ£€æµ‹é¼»å­æ˜¯å¦æ˜æ˜¾é«˜äºè‚©è†€ï¼ˆæŠ¬å¤´çŠ¶æ€ï¼‰
                    const noseY = kp.nose.y;
                    const shoulderY = (kp.ls.y + kp.rs.y) / 2;

                    // é¼»å­æ˜æ˜¾é«˜äºè‚©è†€è¯´æ˜åœ¨æŠ¬å¤´
                    return noseY < shoulderY - 0.1;
                }
            }
        ];

        // --- 2. çŠ¶æ€ ---
        let state = {
            active: false,
            paused: false,
            dist: 0,
            score: 0,
            startTime: 0,
            pausedTime: 0,
            lastWristY: { l: 0, r: 0 },
            lastSwingTime: 0,
            passedThresholds: [],
            challenge: null,
            challengeStart: null,
            challengeStartTime: null,
            challengeTimeout: null,
            currentRunMoments: [],
            itemSystem: null,
            particleSystem: null,
            isStunned: false,
            stunEndTime: 0,
            timeLeft: 180
        };

        let detector, video, canvas, ctx;
        let isModelLoaded = false;
        let preloadPromise = null; // é¢„åŠ è½½ Promise

        // --- 3. é¡µé¢æ‰“å¼€æ—¶é¢„åŠ è½½æ‘„åƒå¤´+æ¨¡å‹ ---
        function startPreload() {
            const loadingText = document.getElementById('loading-text');
            const btnStart = document.getElementById('btn-start');
            loadingText.style.display = 'block';
            btnStart.disabled = true;
            btnStart.style.opacity = '0.5';

            preloadPromise = (async () => {
                try {
                    console.log('é¢„åŠ è½½: åˆå§‹åŒ–æ‘„åƒå¤´...');
                    loadingText.innerHTML = '<span class="spinner">â³</span> æ­£åœ¨è¿æ¥æ‘„åƒå¤´...';
                    await setupCamera();
                    console.log('é¢„åŠ è½½: æ‘„åƒå¤´å°±ç»ª');

                    console.log('é¢„åŠ è½½: åŠ è½½AIæ¨¡å‹(æœ¬åœ°)...');
                    loadingText.innerHTML = '<span class="spinner">â³</span> æ­£åœ¨åŠ è½½AIæ¨¡å‹...';
                    const modelConfig = {
                        modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
                        enableSmoothing: true,
                        modelUrl: 'models/model.json'
                    };
                    detector = await poseDetection.createDetector(
                        poseDetection.SupportedModels.MoveNet, modelConfig
                    );
                    console.log('é¢„åŠ è½½: æ¨¡å‹åŠ è½½å®Œæˆ');

                    isModelLoaded = true;
                    loadingText.innerHTML = 'âœ… å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹!';
                    btnStart.disabled = false;
                    btnStart.style.opacity = '1';
                } catch (err) {
                    console.error('é¢„åŠ è½½å¤±è´¥:', err);
                    loadingText.innerHTML = 'âš ï¸ é¢„åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»å¼€å§‹é‡è¯•';
                    btnStart.disabled = false;
                    btnStart.style.opacity = '1';
                    preloadPromise = null; // å…è®¸é‡è¯•
                }
            })();
        }

        // --- åˆå§‹åŒ–ï¼ˆç”¨æˆ·ç‚¹å‡»å¼€å§‹ï¼‰ ---
        async function init() {
            document.getElementById('menu-buttons').style.display = 'none';
            document.getElementById('loading-text').style.display = 'block';

            try {
                if (!isModelLoaded) {
                    // é¢„åŠ è½½æœªå®Œæˆæˆ–å¤±è´¥ï¼Œé‡æ–°å¯åŠ¨
                    if (!preloadPromise) startPreload();
                    await preloadPromise;
                }

                if (!isModelLoaded) {
                    throw new Error('æ¨¡å‹åŠ è½½å¤±è´¥');
                }

                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('debugger').style.display = 'block';

                startGame();
            } catch (err) {
                console.error('è¯¦ç»†é”™è¯¯:', err);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + err.message + '\n\nè¯·æ£€æŸ¥:\n1. æ˜¯å¦å…è®¸æ‘„åƒå¤´æƒé™\n2. æ˜¯å¦é€šè¿‡æœ¬åœ°æœåŠ¡å™¨è®¿é—®');

                document.getElementById('loading-text').style.display = 'none';
                document.getElementById('menu-buttons').style.display = 'grid';
                const btnStart = document.getElementById('btn-start');
                if (btnStart) btnStart.disabled = false;
            }
        }

        async function setupCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('output');
            ctx = canvas.getContext('2d');

            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480, facingMode: 'user' },
                audio: false
            });
            video.srcObject = stream;

            return new Promise(resolve => {
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    resolve();
                };
            });
        }

        function startGame() {
            state = {
                active: true,
                dist: 0,
                score: 0,
                startTime: Date.now(),
                lastWristY: { l: 0, r: 0 },
                lastSwingTime: 0,
                passedThresholds: [],
                challenge: null,
                challengeStart: null,
                challengeStartTime: null,
                challengeTimeout: null,
                currentRunMoments: [],
                itemSystem: new window.ItemSystem({
                    spawnRate: CONFIG.packetSpawnRate,
                    baseSpeed: CONFIG.packetSpeed
                }),
                particleSystem: new window.ParticleSystem(),
                soundSystem: new window.SoundSystem(),
                isStunned: false,
                stunEndTime: 0,
                timeLeft: CONFIG.gameDuration,
                preparing: false
            };

            // ç»‘å®šå›è°ƒ
            state.itemSystem.onCatch = onPacketCaught;
            state.itemSystem.onHit = onBombHit;

            // æ˜¾ç¤ºæ¸¸æˆæ§åˆ¶æŒ‰é’®
            document.getElementById('game-controls').style.display = 'flex';

            // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            const bgm = document.getElementById('bgm');
            if (bgm) {
                bgm.volume = 0.3; // è®¾ç½®éŸ³é‡ä¸º30%
                bgm.play().catch(err => console.log('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:', err));
            }

            updateUI();
            renderLoop();
        }

        // --- 4. å¾ªç¯ ---
        async function renderLoop() {
            if (!state.active) return;
            if (state.paused) {
                requestAnimationFrame(renderLoop);
                return;
            }

            const poses = await detector.estimatePoses(video);

            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©º
            // ç»˜åˆ¶åŠé€æ˜è’™ç‰ˆä»¥çªå‡ºæŒ‘æˆ˜ï¼Ÿä¸ï¼Œä¿æŒæ¸…æ™°

            // ç»˜åˆ¶ç‰©å“å’Œç²’å­ï¼ˆæ— è®ºæ˜¯å¦æœ‰äººï¼‰
            state.itemSystem.draw(ctx, canvas.width, canvas.height);
            state.particleSystem.draw(ctx, canvas.width, canvas.height);

            if (poses.length > 0) {
                const kp = normalizeKeypoints(poses[0].keypoints);
                drawSkeleton(poses[0].keypoints); // ç»˜åˆ¶éª¨æ¶

                if (kp.nose.score > 0.3) {
                    gameLogic(kp);
                    updateDebug(kp);
                }
            } else {
                // æ²¡æœ‰äººæ—¶ä¹Ÿè¦æ›´æ–°ç‰©å“ç³»ç»Ÿï¼ˆè®©çº¢åŒ…ç»§ç»­æ‰è½ï¼‰
                const now = Date.now();
                state.itemSystem.update(null, now, state.timeLeft);
                state.particleSystem.update();

                // ç»§ç»­å€’è®¡æ—¶
                const elapsed = (now - state.startTime) / 1000;
                state.timeLeft = Math.max(0, CONFIG.gameDuration - elapsed);
                if (state.timeLeft <= 0) {
                    winGame();
                    return;
                }
            }

            updateUI();
            requestAnimationFrame(renderLoop);
        }

        // --- 5. é€»è¾‘ ---
        function normalizeKeypoints(raw) {
            const w = canvas.width;
            const h = canvas.height;
            const map = {};
            raw.forEach(p => {
                map[p.name] = { x: p.x / w, y: p.y / h, score: p.score };
            });
            // åˆ«å
            map.lw = map['left_wrist'];
            map.rw = map['right_wrist'];
            map.ls = map['left_shoulder'];
            map.rs = map['right_shoulder'];
            map.la = map['left_ankle'];
            map.ra = map['right_ankle'];
            map.lk = map['left_knee'];
            map.rk = map['right_knee'];
            return map;
        }

        function gameLogic(kp) {
            const now = Date.now();

            // æ—¶é—´å€’è®¡æ—¶
            const elapsed = (now - state.startTime) / 1000;
            state.timeLeft = Math.max(0, CONFIG.gameDuration - elapsed);

            if (state.timeLeft <= 0) {
                winGame();
                return;
            }

            // 1. Priority: Preparing -> Challenge -> Stunned -> Normal

            if (state.preparing) {
                // Completely freeze items and running
                // Only allow particles (for countdown effects if any)
                state.particleSystem.update();
                return;
            }

            if (state.challenge) {
                // In challenge: no items, no running, just pose check
                state.particleSystem.update();
                processChallenge(kp);
                return;
            }

            // 2. Normal Game Loop

            state.itemSystem.update(kp, now, state.timeLeft);
            state.particleSystem.update();

            // Stunned check
            if (state.isStunned) {
                if (now > state.stunEndTime) {
                    state.isStunned = false;
                } else {
                    return;
                }
            }

            // è·‘æ­¥æ£€æµ‹: æ‰‹è…•å‚ç›´æ‘†åŠ¨
            const deltaL = Math.abs(kp.lw.y - state.lastWristY.l);
            const deltaR = Math.abs(kp.rw.y - state.lastWristY.r);

            // ç¨å¾®è°ƒé«˜é˜ˆå€¼é˜²æ­¢æŠ–åŠ¨è¯¯åˆ¤
            if ((deltaL > 0.02 || deltaR > 0.02) && (now - state.lastSwingTime > 150)) {
                state.dist += 4; // åŠ é€Ÿè·‘!
                // åˆ†æ•°åªé€šè¿‡æ¥çº¢åŒ…è·å¾—
                state.lastSwingTime = now;
            }
            state.lastWristY = { l: kp.lw.y, r: kp.rw.y };

            // è§¦å‘æŒ‘æˆ˜ (åŸºäºæ—¶é—´)
            const elapsedSeconds = Math.floor((CONFIG.gameDuration - state.timeLeft));
            CONFIG.thresholds.forEach(t => {
                if (elapsedSeconds >= t && !state.passedThresholds.includes(t)) {
                    state.passedThresholds.push(t);
                    startChallenge();
                }
            });

            // èƒœåˆ©åˆ¤å®šç§»åˆ°äº†ä¸Šé¢ï¼ˆæ—¶é—´ç»“æŸï¼‰
        }

        // --- æŒ‘æˆ˜ç³»ç»Ÿ ---
        function startChallenge() {
            const pool = CHALLENGES;
            let selected;

            // ä»æ‰€æœ‰ä»»åŠ¡ä¸­å®Œå…¨éšæœºé€‰æ‹©
            selected = pool[Math.floor(Math.random() * pool.length)];

            // é¢„åŠ è½½æŒ‘æˆ˜å›¾æ ‡å›¾ç‰‡ï¼ˆç”¨äºæˆªå›¾æ°´å°ï¼‰
            if (/\.(svg|jpg|jpeg|png|webp|gif)$/i.test(selected.icon)) {
                const img = new Image();
                img.src = selected.icon;
                selected._iconImg = img;
            }

            // 1. Enter Prep Mode
            state.preparing = true;
            state.itemSystem.items = []; // Clear current items

            // 2. Show Modal Info (Hide Timer initially)
            const m = document.getElementById('challenge-modal');
            document.getElementById('c-title').innerText = selected.name;

            // æ˜¾ç¤ºå›¾æ ‡ï¼ˆæ”¯æŒ svg/jpg/png ç­‰å›¾ç‰‡æ ¼å¼ï¼‰
            const iconEl = document.getElementById('c-icon');
            if (/\.(svg|jpg|jpeg|png|webp|gif)$/i.test(selected.icon)) {
                iconEl.innerHTML = `<img src="${selected.icon}" class="challenge-icon-svg" alt="${selected.name}">`;
            } else {
                iconEl.innerText = selected.icon;
            }

            document.getElementById('c-desc').innerText = selected.desc;
            document.getElementById('c-timer-container').style.display = 'none';
            m.classList.add('active');

            // 3. Countdown Sequence
            let count = 3;
            const overlay = document.getElementById('countdown-overlay');

            const runCountdown = () => {
                state.soundSystem.play('tick');
                overlay.innerText = count;
                overlay.style.display = 'block';
                // Trigger reflow for animation if needed, or CSS animation handle it

                if (count <= 0) {
                    // START
                    overlay.style.display = 'none';
                    state.preparing = false;
                    state.challenge = selected;
                    state.challengeStart = null;
                    state.challengeStartTime = Date.now(); // è®°å½•æŒ‘æˆ˜å¼€å§‹æ—¶é—´

                    const tContainer = document.getElementById('c-timer-container');
                    tContainer.style.display = 'block';
                    document.getElementById('c-timer').innerText = "3.0";

                    // Reset Circle
                    const circle = document.getElementById('c-timer-bar');
                    if (circle) {
                        circle.style.strokeDasharray = 440;
                        circle.style.strokeDashoffset = 0;
                        circle.classList.remove('success');
                    }

                    // è®¾ç½®30ç§’è¶…æ—¶è‡ªåŠ¨è·³è¿‡
                    state.challengeTimeout = setTimeout(() => {
                        if (state.challenge) {
                            skipChallenge();
                            showToast('â° ä»»åŠ¡è¶…æ—¶ï¼Œå·²è‡ªåŠ¨è·³è¿‡');
                        }
                    }, 30000);

                    state.soundSystem.play('collect'); // Go sound
                } else {
                    count--;
                    setTimeout(runCountdown, 1000);
                }
            };

            runCountdown();
        }

        function processChallenge(kp) {
            const challenge = state.challenge;

            // è®¡æ—¶é€»è¾‘
            const passed = state.challenge.check(kp);
            const timerEl = document.getElementById('c-timer');
            const timerBar = document.getElementById('c-timer-bar');
            const totalCircumference = 440; // 2 * PI * 70

            // æ›´æ–°è¶…æ—¶å€’è®¡æ—¶æ˜¾ç¤º
            if (state.challengeStartTime) {
                const elapsed = (Date.now() - state.challengeStartTime) / 1000;
                const timeoutRemain = Math.max(0, 30 - elapsed);
                const timeoutEl = document.getElementById('c-timeout');
                if (timeoutEl) {
                    timeoutEl.innerText = `è¶…æ—¶å€’è®¡æ—¶: ${Math.ceil(timeoutRemain)}ç§’`;
                    if (timeoutRemain < 10) {
                        timeoutEl.style.color = '#FF5252'; // çº¢è‰²è­¦å‘Š
                    }
                }
            }

            if (passed) {
                if (!state.challengeStart) state.challengeStart = Date.now();
                const held = Date.now() - state.challengeStart;
                const remain = Math.max(0, (CONFIG.holdTime - held) / 1000);

                // Update Text
                timerEl.innerText = remain.toFixed(1);
                timerEl.style.color = '#00E676'; // Green text

                // Update Ring Progress
                const progress = held / CONFIG.holdTime; // 0 to 1
                const offset = totalCircumference * progress;
                timerBar.style.strokeDashoffset = offset;

                timerBar.classList.add('success'); // Optional: change color

                if (held >= CONFIG.holdTime) {
                    completeChallenge();
                }
            } else {
                state.challengeStart = null;
                timerEl.innerText = "3.0";
                timerEl.style.color = 'white';

                // Reset Ring
                timerBar.style.strokeDashoffset = 0;
                timerBar.classList.remove('success');
            }
        }

        function completeChallenge() {
            // 1. æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨ï¼ˆé‡è¦ï¼é˜²æ­¢å½±å“ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰
            if (state.challengeTimeout) {
                clearTimeout(state.challengeTimeout);
                state.challengeTimeout = null;
            }

            // 2. æŠ“æ‹
            captureSnapshot();

            // 3. å¥–åŠ±
            state.dist += 50;
            state.score += 1000; // æŒ‘æˆ˜æˆåŠŸ +1000åˆ†
            const cName = state.challenge.name;

            // 4. UIé‡ç½®
            state.challenge = null;
            state.challengeStart = null;
            state.challengeStartTime = null;
            document.getElementById('challenge-modal').classList.remove('active');

            // 5. æç¤º
            state.soundSystem.play('complete');
            showToast(`ğŸ“¸ å®Œç¾! +1000åˆ†`);
        }

        // --- æš‚åœ/æ¢å¤æ¸¸æˆ ---
        window.togglePause = function() {
            if (!state.active) return;

            state.paused = !state.paused;
            const pauseBtn = document.getElementById('pause-btn');
            const bgm = document.getElementById('bgm');

            if (state.paused) {
                pauseBtn.innerText = 'â–¶ï¸ ç»§ç»­';
                if (bgm) bgm.pause();
                state.pausedTime = Date.now();
            } else {
                pauseBtn.innerText = 'â¸ï¸ æš‚åœ';
                if (bgm) bgm.play().catch(err => console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', err));
                // è°ƒæ•´å¼€å§‹æ—¶é—´ä»¥è¡¥å¿æš‚åœæ—¶é—´
                const pauseDuration = Date.now() - state.pausedTime;
                state.startTime += pauseDuration;
                if (state.challengeStartTime) {
                    state.challengeStartTime += pauseDuration;
                }
            }
        }

        // --- ç»“æŸæ¸¸æˆ ---
        window.endGame = function() {
            if (!state.active) return;

            if (confirm('ç¡®å®šè¦ç»“æŸæ¸¸æˆå—ï¼Ÿ')) {
                winGame();
            }
        }

        // --- è·³è¿‡ä»»åŠ¡ ---
        window.skipChallenge = function() {
            if (!state.challenge) return;

            // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
            if (state.challengeTimeout) {
                clearTimeout(state.challengeTimeout);
                state.challengeTimeout = null;
            }

            // é‡ç½®æ‰€æœ‰æŒ‘æˆ˜ç›¸å…³çŠ¶æ€
            state.challenge = null;
            state.challengeStart = null;
            state.challengeStartTime = null;
            state.preparing = false;

            // éšè—å¼¹çª—
            document.getElementById('challenge-modal').classList.remove('active');

            // æç¤º
            showToast('â­ï¸ å·²è·³è¿‡ä»»åŠ¡');
        }

        // --- é‡æ–°å¼€å§‹æ¸¸æˆï¼ˆå›åˆ°ä¸»ç•Œé¢ï¼‰---
        window.restartGame = function() {
            // ç›´æ¥åˆ·æ–°é¡µé¢ï¼Œæœ€ç®€å•å¯é 
            location.reload();
        }

        // --- æŠ“æ‹ ---
        function captureSnapshot() {
            // é—ªå…‰ç‰¹æ•ˆ
            const flash = document.getElementById('flash');
            flash.style.opacity = 0.8;
            setTimeout(() => flash.style.opacity = 0, 100);

            // æˆªå›¾
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶CanvasæŠŠVideoå’Œå½“å‰çš„éª¨æ¶(Output)åˆæˆï¼Ÿ
            // æˆ–è€…åªæˆªVideoæ›´çœŸå®ï¼ŸUser wants "photos" usually means them.
            // Let's draw video then overlay text/icon.

            const snapCanvas = document.createElement('canvas');
            // ç¼©å°æˆªå›¾å°ºå¯¸ä»¥å‡å°‘å­˜å‚¨ç©ºé—´ï¼ˆæœ€å¤§å®½åº¦240pxï¼Œç¡®ä¿èƒ½ä¿å­˜ï¼‰
            const maxWidth = 960;
            const scale = Math.min(1, maxWidth / video.videoWidth);
            snapCanvas.width = video.videoWidth * scale;
            snapCanvas.height = video.videoHeight * scale;
            const sCtx = snapCanvas.getContext('2d');

            // ç»˜åˆ¶è§†é¢‘ (éœ€è¦æ°´å¹³ç¿»è½¬ä»¥åŒ¹é…é•œåƒæ˜¾ç¤ºï¼Œæˆ–è€…å°±å­˜é•œåƒåçš„)
            // è¿™é‡Œçš„ video css transform scaleX(-1) åªæ˜¯æ˜¾ç¤ºçš„ã€‚ç»˜åˆ¶åˆ°Canvasæ˜¯åŸå§‹çš„ã€‚
            // ä¸ºäº†æ‰€è§å³æ‰€å¾—ï¼Œæˆ‘ä»¬ç»˜åˆ¶æ—¶ä¹Ÿè¦ç¿»è½¬ã€‚
            sCtx.save();
            sCtx.scale(-1, 1);
            sCtx.drawImage(video, -snapCanvas.width, 0, snapCanvas.width, snapCanvas.height);
            sCtx.restore();

            // ç»˜åˆ¶å½“å‰æŒ‘æˆ˜æ°´å°ï¼šå³ä¸Šè§’æ”¾æŒ‡å¼•å›¾ç‰‡ + å·¦ä¸‹è§’çº¢åº•æŒ‘æˆ˜å
            if (state.challenge) {
                const sw = snapCanvas.width;
                const sh = snapCanvas.height;

                // å³ä¸Šè§’ï¼šæŒ‘æˆ˜æŒ‡å¼•å›¾ç‰‡
                const iconImg = state.challenge._iconImg;
                if (iconImg && iconImg.complete && iconImg.naturalWidth > 0) {
                    const iconSize = Math.floor(100 * scale);
                    const margin = Math.floor(10 * scale);
                    const ix = sw - iconSize - margin;
                    const iy = margin;
                    // åœ†è§’è£å‰ª
                    const radius = Math.floor(10 * scale);
                    sCtx.save();
                    sCtx.beginPath();
                    sCtx.roundRect(ix, iy, iconSize, iconSize, radius);
                    sCtx.clip();
                    sCtx.drawImage(iconImg, ix, iy, iconSize, iconSize);
                    sCtx.restore();
                    // è¾¹æ¡†
                    sCtx.strokeStyle = 'rgba(255,215,0,0.8)';
                    sCtx.lineWidth = 2 * scale;
                    sCtx.beginPath();
                    sCtx.roundRect(ix, iy, iconSize, iconSize, radius);
                    sCtx.stroke();
                }

                // å·¦ä¸‹è§’ï¼šçº¢åº• + ç™½å­—æŒ‘æˆ˜å
                const fontSize = Math.floor(22 * scale);
                sCtx.font = `bold ${fontSize}px sans-serif`;
                const name = state.challenge.name;
                const textW = sCtx.measureText(name).width;
                const padX = Math.floor(12 * scale);
                const padY = Math.floor(8 * scale);
                const pillW = textW + padX * 2;
                const pillH = fontSize + padY * 2;
                const px = Math.floor(10 * scale);
                const py = sh - pillH - Math.floor(10 * scale);

                // çº¢è‰²åœ†è§’èƒŒæ™¯
                sCtx.fillStyle = 'rgba(230, 0, 18, 0.85)';
                sCtx.beginPath();
                sCtx.roundRect(px, py, pillW, pillH, Math.floor(pillH / 2));
                sCtx.fill();

                // ç™½è‰²æ–‡å­—
                sCtx.fillStyle = '#FFFFFF';
                sCtx.fillText(name, px + padX, py + padY + fontSize * 0.85);
            }

            // å‹ç¼©å¹¶ä¿å­˜ï¼ˆä½¿ç”¨è¾ƒä½çš„è´¨é‡ï¼Œç¡®ä¿èƒ½ä¿å­˜ï¼‰
            const base64 = AppStorage.compressCanvas(snapCanvas, 0.8);

            // è°ƒè¯•ï¼šæ˜¾ç¤ºç…§ç‰‡å¤§å°
            const photoSizeKB = (base64.length / 1024).toFixed(2);
            console.log(`ğŸ“¸ ç…§ç‰‡å¤§å°: ${photoSizeKB} KB`);

            // åˆ›å»ºç…§ç‰‡å¯¹è±¡
            const moment = {
                id: Date.now() + Math.random().toString().slice(2, 6),
                timestamp: new Date().toISOString(),
                challengeName: state.challenge ? state.challenge.name : 'è‡ªç”±æ—¶åˆ»',
                challengeIcon: state.challenge ? state.challenge.icon : 'ğŸƒ',
                imageData: base64
            };

            // ä¿å­˜åˆ°å½“å‰æ¸¸æˆçš„ä¸´æ—¶æ•°ç»„
            state.currentRunMoments.push(moment);
        }

        // --- ç»“ç®— ---
        async function winGame() {
            state.active = false;

            // åœæ­¢èƒŒæ™¯éŸ³ä¹
            const bgm = document.getElementById('bgm');
            if (bgm) {
                bgm.pause();
                bgm.currentTime = 0;
            }

            // éšè—æ¸¸æˆæ§åˆ¶æŒ‰é’®
            document.getElementById('game-controls').style.display = 'none';

            const finalScore = state.score;

            // ä¿å­˜æˆç»©
            const moments = state.currentRunMoments;
            let moment1 = null;
            let moment2 = null;
            if (moments.length > 0) moment1 = moments[moments.length - 1];
            if (moments.length > 1) moment2 = moments[moments.length - 2];

            try {
                await AppStorage.saveScore({
                    score: finalScore,
                    date: new Date().toLocaleString(),
                    snapshotCount: moments.length,
                    moment1: moment1,
                    moment2: moment2
                });
            } catch (err) {
                console.error('ä¿å­˜åˆ†æ•°å¤±è´¥:', err);
            }

            // æ˜¾ç¤ºç»“æœç•Œé¢
            const ov = document.getElementById('overlay');
            ov.style.display = 'flex';
            document.getElementById('menu-content').style.display = 'none';
            document.getElementById('result-content').style.display = 'flex';
            document.querySelector('.game-tips-box').style.display = 'none';
            document.getElementById('res-time').innerText = finalScore;

            // åŠ è½½ Top 3 å¹¶åˆ¤æ–­æ–°çºªå½•
            await loadBestScores(finalScore);
        }

        // --- è¾…åŠ© ---
        function updateUI() {
            if (!state.active) return;

            // å€’è®¡æ—¶æ˜¾ç¤º
            const t = Math.ceil(state.timeLeft);
            const m = String(Math.floor(t / 60)).padStart(2, '0');
            const s = String(t % 60).padStart(2, '0');

            const timeEl = document.getElementById('disp-time');
            timeEl.innerText = `${m}:${s}`;

            // æ—¶é—´å°‘äº10ç§’å˜çº¢
            if (t <= 10) timeEl.style.color = '#FF5252';
            else timeEl.style.color = '#FFF';

            document.getElementById('disp-cal').innerText = state.score; // æ˜¾ç¤ºåˆ†æ•°

            const pct = (state.timeLeft / CONFIG.gameDuration) * 100;
            document.getElementById('prog-fill').style.width = pct + "%";
        }

        function drawSkeleton(keypoints) {
            ctx.fillStyle = '#00E676';
            ctx.strokeStyle = '#00E676';
            ctx.lineWidth = 2;

            // ç»˜åˆ¶ç‚¹
            keypoints.forEach(p => {
                if (p.score > 0.3) {
                    ctx.beginPath();
                    // è¢«ç‚¸æ™•æ—¶èº«ä½“å˜çº¢
                    ctx.fillStyle = state.isStunned ? '#FF0000' : '#00E676';
                    ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }

        function onBombHit(item) {
            // æƒ©ç½š: æ‰£åˆ† + çœ©æ™•
            state.score = Math.max(0, state.score - 500);
            state.isStunned = true;
            state.stunEndTime = Date.now() + 2000; // æ™•2ç§’

            // ç‰¹æ•ˆ
            state.soundSystem.play('bomb');
            state.particleSystem.emitText(item.x, item.y, "-500");
            state.particleSystem.emit(item.x, item.y, '#FF0000', 30);

            // å±å¹•éœ‡åŠ¨æ•ˆæœ (ç®€å•ç‰ˆ)
            document.body.style.transform = "translate(5px, 5px)";
            setTimeout(() => document.body.style.transform = "none", 100);
        }

        function onPacketCaught(d) {
            let bonus = 100;
            let msg = 'ğŸ§§ +100åˆ†';

            let color = '#FFD700';

            if (d.type === 'gold') {
                bonus = 500;
                msg = 'âœ¨ +500åˆ†';
                color = '#FFFF00';
            } else if (d.type === 'lion') {
                bonus = 2000;
                msg = 'ğŸ¦ èˆç‹®è§‰é†’! +2000åˆ†';
                color = '#FF5252';
                // æé€Ÿæ¨¡å¼ï¼šé‡Œç¨‹å¢åŠ åŠ å¿« (æŒç»­5ç§’)
                activateSpeedBoost();
                state.soundSystem.play('lion');
            } else {
                state.soundSystem.play(d.type === 'normal' ? 'collect' : 'gold');
            }

            state.score += bonus;
            // showToast(msg); // ç”¨ç²’å­æ–‡å­—æ›¿ä»£

            state.particleSystem.emitText(d.x, d.y, `+${bonus}`, color);
            state.particleSystem.emit(d.x, d.y, color, d.type === 'lion' ? 50 : 20);
        }

        let boostTimer = null;
        function activateSpeedBoost() {
            // ç®€å•å®ç°: è®©è·‘æ­¥åˆ¤å®šæ›´çµæ•ï¼Œæˆ–è€…æ¯å¸§è‡ªåŠ¨åŠ åˆ†
            if (boostTimer) clearTimeout(boostTimer);

            CONFIG.packetSpawnRate = 600; // ç–¯ç‹‚æ‰è½
            state.itemSystem.config.spawnRate = 600; // Update config
            document.getElementById('speed-lines').classList.add('active'); // è§†è§‰çº¿ç‰¹æ•ˆ

            boostTimer = setTimeout(() => {
                CONFIG.packetSpawnRate = 1500; // æ¢å¤
                state.itemSystem.config.spawnRate = 1500;
                document.getElementById('speed-lines').classList.remove('active');
                boostTimer = null;
            }, 5000);
        }

        function updateDebug(kp) {
            const dbg = document.getElementById('debugger');
            // dbg.innerHTML = `Nose Y: ${kp.nose.y.toFixed(2)}`; 
            // è°ƒè¯•æ¨¡å¼å¯å…³
        }

        // --- ä¸ªäººæœ€ä½³ Top 3 ---
        async function loadBestScores(currentScore) {
            try {
                const scores = await AppStorage.getScores();
                const top3 = scores.slice(0, 3);

                // åˆ¤æ–­æ˜¯å¦æ–°çºªå½•ï¼ˆå½“å‰åˆ†æ•°æ˜¯å†å²æœ€é«˜ï¼‰
                const badge = document.getElementById('new-record-badge');
                if (badge && top3.length > 0 && currentScore >= parseFloat(top3[0].score)) {
                    badge.style.display = 'block';
                } else if (badge) {
                    badge.style.display = 'none';
                }

                // æ¸²æŸ“åˆ°ç»“æŸç•Œé¢
                renderTop3('result-best-list', top3, currentScore);
            } catch (e) {
                console.error('åŠ è½½æœ€ä½³æˆç»©å¤±è´¥:', e);
            }
        }

        function renderTop3(containerId, top3, highlightScore) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (top3.length === 0) {
                container.innerHTML = '<span style="color:#aaa;">æš‚æ— è®°å½•</span>';
                return;
            }

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            container.innerHTML = top3.map((s, i) => {
                const isHighlight = highlightScore !== undefined && parseFloat(s.score) === highlightScore;
                const style = isHighlight ? 'color:#FFD700; font-weight:bold;' : '';
                return `<div style="${style}">${medals[i]} ${s.score} åˆ† <span style="color:#aaa; font-size:12px;">${s.date || ''}</span></div>`;
            }).join('');
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.innerText = msg;
            toast.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: #FFD700;
                padding: 15px 30px;
                border-radius: 50px;
                font-size: 20px;
                font-weight: bold;
                z-index: 2000;
                animation: fadeUp 1.5s forwards;
            `;
            document.body.appendChild(toast);

            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fadeUp {
                    0% { opacity:0; transform:translate(-50%, -20%); }
                    20% { opacity:1; transform:translate(-50%, -50%); }
                    80% { opacity:1; transform:translate(-50%, -50%); }
                    100% { opacity:0; transform:translate(-50%, -80%); }
                }
            `;
            document.head.appendChild(style);

            setTimeout(() => {
                toast.remove();
                style.remove();
            }, 1500);
        }

        // --- æŸ¥çœ‹ç…§ç‰‡ï¼ˆTop 3 å†å²æˆç»© + ç…§ç‰‡ï¼‰---
        window.viewPhotos = async function() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position:fixed; inset:0; background:#000;
                z-index:3000; display:flex; flex-direction:column;
                align-items:center; padding:30px 20px;
                overflow-y:auto;
            `;

            // æ ‡é¢˜
            const title = document.createElement('p');
            title.style.cssText = 'color:#FFD700; font-size:20px; font-weight:700; margin:0 0 20px 0; letter-spacing:2px;';
            title.innerText = 'ğŸ† ä¸ªäººæœ€ä½³ Top 3';
            overlay.appendChild(title);

            // åŠ è½½ Top 3 æˆç»©åŠç…§ç‰‡
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            try {
                const scores = await AppStorage.getScores();
                const top3 = scores.slice(0, 3);

                if (top3.length === 0) {
                    const empty = document.createElement('div');
                    empty.style.cssText = 'color:#aaa; font-size:14px; margin:20px 0;';
                    empty.innerText = 'æš‚æ— è®°å½•';
                    overlay.appendChild(empty);
                }

                top3.forEach((s, i) => {
                    // æ¯æ¡è®°å½•çš„å®¹å™¨
                    const card = document.createElement('div');
                    card.style.cssText = `
                        width:100%; max-width:400px; margin-bottom:20px;
                        background:rgba(255,255,255,0.05); border-radius:15px;
                        padding:15px; border:1px solid rgba(255,215,0,0.3);
                    `;

                    // åˆ†æ•°è¡Œ
                    const scoreLine = document.createElement('div');
                    scoreLine.style.cssText = 'color:#fff; font-size:16px; font-weight:600; margin-bottom:10px;';
                    scoreLine.innerHTML = `${medals[i]} ${s.score} åˆ† <span style="color:#aaa; font-size:12px; margin-left:8px;">${s.date || ''}</span>`;
                    card.appendChild(scoreLine);

                    // ç…§ç‰‡è¡Œ
                    const photoRow = document.createElement('div');
                    photoRow.style.cssText = 'display:flex; gap:8px; justify-content:center;';

                    const moments = [s.moment1, s.moment2].filter(m => m && m.imageData);
                    if (moments.length > 0) {
                        moments.forEach(m => {
                            const img = document.createElement('img');
                            img.src = m.imageData;
                            img.style.cssText = 'width:160px; height:120px; object-fit:cover; border-radius:8px; border:2px solid rgba(255,215,0,0.5); cursor:pointer;';
                            img.onclick = () => AppStorage.downloadImage(m.imageData, 'snapshot_' + (m.timestamp || Date.now()) + '.jpg');
                            photoRow.appendChild(img);
                        });
                    } else {
                        const noPhoto = document.createElement('span');
                        noPhoto.style.cssText = 'color:#666; font-size:12px;';
                        noPhoto.innerText = 'æ— æˆªå›¾';
                        photoRow.appendChild(noPhoto);
                    }

                    card.appendChild(photoRow);
                    overlay.appendChild(card);
                });
            } catch (e) {
                const errEl = document.createElement('div');
                errEl.style.cssText = 'color:#aaa; font-size:14px;';
                errEl.innerText = 'åŠ è½½å¤±è´¥';
                overlay.appendChild(errEl);
            }

            // æŒ‰é’®åŒºåŸŸ
            const btnBox = document.createElement('div');
            btnBox.style.cssText = 'display:flex; gap:15px; margin-top:20px;';

            // å…³é—­æŒ‰é’®ï¼ˆè¿”å›ç»“ç®—é¡µï¼‰
            const closeBtn = document.createElement('button');
            closeBtn.innerText = 'å…³é—­';
            closeBtn.style.cssText = `
                padding:10px 30px; border:none;
                background:rgba(255,255,255,0.15); color:#fff; font-weight:bold;
                border-radius:25px; font-size:16px; cursor:pointer;
                border:1px solid rgba(255,255,255,0.3);
            `;
            closeBtn.onclick = () => overlay.remove();
            btnBox.appendChild(closeBtn);

            // è¿”å›ä¸»é¡µæŒ‰é’®
            const homeBtn = document.createElement('button');
            homeBtn.innerText = 'è¿”å›ä¸»é¡µ';
            homeBtn.style.cssText = `
                padding:10px 30px; border:none;
                background:#FFD700; color:#000; font-weight:bold;
                border-radius:25px; font-size:16px; cursor:pointer;
            `;
            homeBtn.onclick = () => location.reload();
            btnBox.appendChild(homeBtn);

            overlay.appendChild(btnBox);
            document.body.appendChild(overlay);
        }

        // --- é¡µé¢åŠ è½½ï¼šé¢„åŠ è½½ + æ˜¾ç¤ºå†å² Top 3 ---
        (async function() {
            // å¯åŠ¨é¢„åŠ è½½
            startPreload();

            // æ˜¾ç¤ºä¸»èœå•å†å²æœ€ä½³
            try {
                await AppStorage.init();
                const scores = await AppStorage.getScores();
                const top3 = scores.slice(0, 3);
                if (top3.length > 0) {
                    document.getElementById('menu-best').style.display = 'block';
                    renderTop3('menu-best-list', top3);
                }
            } catch (e) {
                console.error('åŠ è½½å†å²æˆç»©å¤±è´¥:', e);
            }
        })();
    </script>
</body>

</html>